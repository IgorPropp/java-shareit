


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=windows-1251"> 
  <title>Coverage Report > BookingServiceImpl</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">ru.practicum.shareit.booking.service</a>
</div>

<h1>Coverage Summary for Class: BookingServiceImpl (ru.practicum.shareit.booking.service)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">BookingServiceImpl</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (6/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    84,5%
  </span>
  <span class="absValue">
    (71/84)
  </span>
</td>
</tr>
  <tr>
    <td class="name">BookingServiceImpl$1</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">BookingServiceImpl$MockitoMock$kneV19ll</td>
  </tr>
  <tr>
    <td class="name">BookingServiceImpl$MockitoMock$kneV19ll$auxiliary$HZPEvdrT</td>
  </tr>
  <tr>
    <td class="name">BookingServiceImpl$MockitoMock$kneV19ll$auxiliary$LAecldtF</td>
  </tr>
  <tr>
    <td class="name">BookingServiceImpl$MockitoMock$kneV19ll$auxiliary$ofESerQ5</td>
  </tr>
  <tr>
    <td class="name">BookingServiceImpl$MockitoMock$kneV19ll$auxiliary$Tegq9OJQ</td>
  </tr>
  <tr>
    <td class="name">BookingServiceImpl$MockitoMock$kneV19ll$auxiliary$tIHD22Ix</td>
  </tr>
  <tr>
    <td class="name">BookingServiceImpl$MockitoMock$kneV19ll$auxiliary$x7GwKdmx</td>
  </tr>
  <tr>
    <td class="name">BookingServiceImpl$MockitoMock$kneV19ll$auxiliary$YGvpy0R6</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (7/7)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    84,7%
  </span>
  <span class="absValue">
    (72/85)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package ru.practicum.shareit.booking.service;
&nbsp;
&nbsp;import lombok.AllArgsConstructor;
&nbsp;import org.springframework.data.domain.PageRequest;
&nbsp;import org.springframework.data.domain.Pageable;
&nbsp;import org.springframework.data.domain.Sort;
&nbsp;import org.springframework.http.HttpStatus;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;import org.springframework.web.server.ResponseStatusException;
&nbsp;import ru.practicum.shareit.booking.BookingMapper;
&nbsp;import ru.practicum.shareit.booking.dto.BookingDto;
&nbsp;import ru.practicum.shareit.booking.dto.BookingDtoRequest;
&nbsp;import ru.practicum.shareit.booking.enums.BookingState;
&nbsp;import ru.practicum.shareit.booking.enums.BookingStatus;
&nbsp;import ru.practicum.shareit.booking.model.Booking;
&nbsp;import ru.practicum.shareit.booking.storage.BookingStorage;
&nbsp;import ru.practicum.shareit.item.ItemMapper;
&nbsp;import ru.practicum.shareit.item.dto.ItemDto;
&nbsp;import ru.practicum.shareit.item.model.Item;
&nbsp;import ru.practicum.shareit.item.storage.ItemStorage;
&nbsp;import ru.practicum.shareit.user.User;
&nbsp;import ru.practicum.shareit.user.UserMapper;
&nbsp;import ru.practicum.shareit.user.dto.UserDto;
&nbsp;import ru.practicum.shareit.user.storage.UserStorage;
&nbsp;
&nbsp;import java.time.LocalDateTime;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.List;
&nbsp;import java.util.NoSuchElementException;
&nbsp;import java.util.stream.Collectors;
&nbsp;
&nbsp;@Service
&nbsp;@AllArgsConstructor
&nbsp;public class BookingServiceImpl implements BookingService {
&nbsp;    private final ItemStorage itemStorage;
&nbsp;    private final UserStorage userStorage;
&nbsp;    private final BookingStorage bookingStorage;
&nbsp;    private final BookingMapper bookingMapper;
&nbsp;    private final UserMapper userMapper;
&nbsp;    private final ItemMapper itemMapper;
&nbsp;
&nbsp;    public BookingDto create(Long userId, BookingDtoRequest bookingDtoRequest) throws IllegalAccessException {
<b class="fc">&nbsp;        if (!bookingDatesAreValid(bookingDtoRequest)) {</b>
<b class="nc">&nbsp;            throw new ResponseStatusException(HttpStatus.BAD_REQUEST, &quot;Booking time is incorrect&quot;);</b>
&nbsp;        }
<b class="fc">&nbsp;        UserDto userDto = userMapper.toDto(userStorage.findById(userId).orElseThrow());</b>
<b class="fc">&nbsp;        ItemDto itemDto = itemMapper.toDto(itemStorage.findById(bookingDtoRequest.getItemId()).orElseThrow());</b>
<b class="fc">&nbsp;        if (itemStorage.getById(bookingDtoRequest.getItemId()).getOwner().getId().equals(userId))</b>
<b class="nc">&nbsp;            throw new NoSuchElementException(&quot;Booker is the owner&quot;);</b>
<b class="fc">&nbsp;        if (itemDto.getAvailable().equals(false)) {</b>
<b class="nc">&nbsp;            throw new IllegalAccessException(&quot;Item is unavailable&quot;);</b>
&nbsp;        }
<b class="fc">&nbsp;        Booking booking = bookingMapper.requestToObject(bookingDtoRequest, itemMapper.fromDto(itemDto),</b>
<b class="fc">&nbsp;                userMapper.fromDto(userDto.getId(), userDto), BookingStatus.WAITING);</b>
<b class="fc">&nbsp;        bookingStorage.save(booking);</b>
<b class="fc">&nbsp;        return bookingMapper.toDto(booking, itemDto, userDto);</b>
&nbsp;    }
&nbsp;
&nbsp;    public BookingDto book(Long userId, Long bookingId, Boolean approved) throws IllegalAccessException {
<b class="fc">&nbsp;        Booking booking = bookingStorage.findById(bookingId).orElseThrow();</b>
<b class="fc">&nbsp;        Item item = itemStorage.findById(booking.getItem().getId()).orElseThrow();</b>
<b class="fc">&nbsp;        User booker = userStorage.findById(booking.getBooker().getId()).orElseThrow();</b>
<b class="fc">&nbsp;        if (item.getOwner().getId().equals(userId)) {</b>
<b class="fc">&nbsp;            if (approved &amp;&amp; booking.getStatus().equals(BookingStatus.APPROVED)) {</b>
<b class="nc">&nbsp;                throw new IllegalAccessException(&quot;Booking is already approved&quot;);</b>
&nbsp;            }
<b class="fc">&nbsp;            if (approved) {</b>
<b class="fc">&nbsp;                booking.setStatus(BookingStatus.APPROVED);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                booking.setStatus(BookingStatus.REJECTED);</b>
&nbsp;            }
<b class="fc">&nbsp;            bookingStorage.save(booking);</b>
<b class="fc">&nbsp;            return bookingMapper.toDto(booking, itemMapper.toDto(item), userMapper.toDto(booker));</b>
&nbsp;        }
<b class="nc">&nbsp;        throw new NoSuchElementException(&quot;Booking not found&quot;);</b>
&nbsp;    }
&nbsp;
&nbsp;    public BookingDto get(Long bookingId, Long userId) {
<b class="fc">&nbsp;        Booking booking = bookingStorage.findById(bookingId).orElseThrow();</b>
<b class="fc">&nbsp;        Item item = itemStorage.findById(booking.getItem().getId()).orElseThrow();</b>
<b class="fc">&nbsp;        User user = userStorage.findById(booking.getBooker().getId()).orElseThrow();</b>
<b class="fc">&nbsp;        if (booking.getBooker().getId().equals(userId) || item.getOwner().getId().equals(userId)) {</b>
<b class="fc">&nbsp;            return bookingMapper.toDto(booking, itemMapper.toDto(item), userMapper.toDto(user));</b>
&nbsp;        }
<b class="nc">&nbsp;        throw new NoSuchElementException(&quot;Booking not found&quot;);</b>
&nbsp;    }
&nbsp;
&nbsp;    public List&lt;BookingDto&gt; getAllBookingsByOwner(Long userId, String string, int page, int size) {
&nbsp;        try {
<b class="fc">&nbsp;            BookingState state = BookingState.valueOf(string);</b>
<b class="fc">&nbsp;            User user = userStorage.findById(userId).orElseThrow();</b>
<b class="fc">&nbsp;            Sort sort = Sort.by(Sort.Direction.DESC, &quot;start&quot;);</b>
<b class="fc">&nbsp;            Pageable pageRequest = PageRequest.of(page, size, sort);</b>
<b class="fc">&nbsp;            List&lt;Long&gt; userItemsIds = itemStorage.findAllByOwner(user)</b>
<b class="fc">&nbsp;                    .stream()</b>
<b class="fc">&nbsp;                    .map(Item::getId)</b>
<b class="fc">&nbsp;                    .collect(Collectors.toList());</b>
&nbsp;            List&lt;Booking&gt; bookingsByOwner;
<b class="fc">&nbsp;            if (!userItemsIds.isEmpty()) {</b>
<b class="fc">&nbsp;                switch (state) {</b>
&nbsp;                    case ALL:
<b class="fc">&nbsp;                        bookingsByOwner = bookingStorage.getAllForOwner(userItemsIds, pageRequest);</b>
<b class="fc">&nbsp;                        break;</b>
&nbsp;                    case CURRENT:
<b class="fc">&nbsp;                        bookingsByOwner = bookingStorage.getCurrentBookingsForOwner(userItemsIds, pageRequest);</b>
<b class="fc">&nbsp;                        break;</b>
&nbsp;                    case PAST:
<b class="fc">&nbsp;                        bookingsByOwner = bookingStorage.getPastBookingsForOwner(userItemsIds, pageRequest);</b>
<b class="fc">&nbsp;                        break;</b>
&nbsp;                    case FUTURE:
<b class="fc">&nbsp;                        bookingsByOwner = bookingStorage.getFutureBookingsForOwner(userItemsIds, pageRequest);</b>
<b class="fc">&nbsp;                        break;</b>
&nbsp;                    case WAITING:
<b class="fc">&nbsp;                        bookingsByOwner = bookingStorage.findBookingByOwnerAndStatusOrderByEndDesc(userItemsIds,</b>
&nbsp;                                BookingStatus.WAITING, pageRequest);
<b class="fc">&nbsp;                        break;</b>
&nbsp;                    case REJECTED:
<b class="fc">&nbsp;                        bookingsByOwner = bookingStorage.findBookingByOwnerAndStatusOrderByEndDesc(userItemsIds,</b>
&nbsp;                                BookingStatus.REJECTED, pageRequest);
<b class="fc">&nbsp;                        break;</b>
&nbsp;                    default:
<b class="nc">&nbsp;                        throw new IllegalArgumentException();</b>
&nbsp;                }
&nbsp;            } else {
<b class="nc">&nbsp;                throw new IllegalStateException(&quot;User has no items&quot;);</b>
&nbsp;            }
<b class="fc">&nbsp;            return bookingsByOwner.stream()</b>
<b class="fc">&nbsp;                    .map(bookingMapper::toDto)</b>
<b class="fc">&nbsp;                    .collect(Collectors.toList());</b>
<b class="nc">&nbsp;        } catch (IllegalArgumentException e) {</b>
<b class="nc">&nbsp;            throw new IllegalArgumentException(&quot;Unknown state: UNSUPPORTED_STATUS&quot;);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public List&lt;BookingDto&gt; getAllBookingsForUserByState(Long userId, String string, int page, int size) {
&nbsp;        try {
<b class="fc">&nbsp;            BookingState state = BookingState.valueOf(string);</b>
<b class="fc">&nbsp;            Long userIdValue = userStorage.findById(userId).orElseThrow().getId();</b>
<b class="fc">&nbsp;            Sort sort = Sort.by(Sort.Direction.DESC, &quot;start&quot;);</b>
<b class="fc">&nbsp;            Pageable pageRequest = PageRequest.of(page, size, sort);</b>
<b class="fc">&nbsp;            List&lt;Booking&gt; bookings = new ArrayList&lt;&gt;();</b>
<b class="fc">&nbsp;            switch (state) {</b>
&nbsp;                case ALL:
<b class="fc">&nbsp;                    bookings = bookingStorage.findAllByBookerOrderByEndDesc(userIdValue, pageRequest);</b>
<b class="fc">&nbsp;                    break;</b>
&nbsp;                case CURRENT:
<b class="fc">&nbsp;                    bookings = bookingStorage.getCurrentBookingsForBooker(userIdValue, pageRequest);</b>
<b class="fc">&nbsp;                    break;</b>
&nbsp;                case PAST:
<b class="fc">&nbsp;                    bookings = bookingStorage.getPastBookingsForBooker(userIdValue, pageRequest);</b>
<b class="fc">&nbsp;                    break;</b>
&nbsp;                case FUTURE:
<b class="fc">&nbsp;                    bookings = bookingStorage.getFutureBookingsForBooker(userIdValue, pageRequest);</b>
<b class="fc">&nbsp;                    break;</b>
&nbsp;                case WAITING:
<b class="fc">&nbsp;                    bookings = bookingStorage.findBookingByBookerAndStatusOrderByEndDesc(userIdValue,</b>
&nbsp;                            BookingStatus.WAITING, pageRequest);
<b class="fc">&nbsp;                    break;</b>
&nbsp;                case REJECTED:
<b class="fc">&nbsp;                    bookings = bookingStorage.findBookingByBookerAndStatusOrderByEndDesc(userIdValue,</b>
&nbsp;                            BookingStatus.REJECTED, pageRequest);
&nbsp;                    break;
&nbsp;            }
<b class="fc">&nbsp;            return bookings.stream()</b>
<b class="fc">&nbsp;                    .map(bookingMapper::toDto)</b>
<b class="fc">&nbsp;                    .collect(Collectors.toList());</b>
<b class="nc">&nbsp;        } catch (IllegalArgumentException e) {</b>
<b class="nc">&nbsp;            throw new IllegalArgumentException(&quot;Unknown state: UNSUPPORTED_STATUS&quot;);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private boolean bookingDatesAreValid(BookingDtoRequest booking) {
<b class="fc">&nbsp;        return booking.getStart() != null &amp;&amp; booking.getEnd() != null &amp;&amp; !booking.getStart().isAfter(booking.getEnd()) &amp;&amp;</b>
<b class="fc">&nbsp;                !booking.getEnd().isBefore(booking.getStart()) &amp;&amp; booking.getStart() != booking.getEnd() &amp;&amp;</b>
<b class="fc">&nbsp;                !booking.getStart().equals(booking.getEnd()) &amp;&amp; !booking.getStart().isBefore(LocalDateTime.now());</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-04-02 20:43</div>
</div>
</body>
</html>
